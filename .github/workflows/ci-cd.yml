name: Go
on: [push]
jobs:

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:

    - name: Set up Go 1.12
      uses: actions/setup-go@v1
      with:
        go-version: 1.12
      id: go

    - name: Check out code into the Go module directory
      uses: actions/checkout@v1

    - name: Install dependancies
      uses: actions/checkout@v1
      run: curl https://glide.sh/get | sh
      run: glide install
       
    - name: Run tests
      run: go test ./... 

    - name: Build code
      env:
        BUILD_NUM: 1
        TAG: v1.0.0-beta
    - run: go get github.com/mitchellh/gox
    - run: |
        if [ -z $TAG ] 
        then
            gox -os="linux" -os="windows" -ldflags "-X main.version=v0.0.0-notag.$BUILD_NUM" -output "artifacts/cstore_{{.OS}}_{{.Arch}}"
        else
            gox -os="linux" -os="windows" -ldflags "-X main.version=$CIRCLE_TAG.$BUILD_NUM" -output "artifacts/cstore_{{.OS}}_{{.Arch}}"
        fi
